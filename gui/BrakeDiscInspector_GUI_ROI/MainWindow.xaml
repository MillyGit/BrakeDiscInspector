<Window x:Class="BrakeDiscInspector_GUI_ROI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:BrakeDiscInspector_GUI_ROI"
        xmlns:m="clr-namespace:BrakeDiscInspector_GUI_ROI.Models"
        xmlns:workflow="clr-namespace:BrakeDiscInspector_GUI_ROI.Workflow"
        xmlns:conv="clr-namespace:BrakeDiscInspector_GUI_ROI.Converters"
        Title="BrakeDiscInspector"
        WindowState="Maximized"
        WindowStartupLocation="CenterScreen"
        Background="#0E0E10"
        UseLayoutRounding="True"
        Loaded="MainWindow_Loaded">

  <Window.Resources>
    <conv:BoolToEditSaveTextConverter x:Key="BoolToEditSaveText" />
  </Window.Resources>

  <Grid x:Name="RootGrid">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="*" />
      <ColumnDefinition x:Name="SidePanelColumn" Width="840" MinWidth="840" />
    </Grid.ColumnDefinitions>

    <!-- ===== Tabs (left) ===== -->
    <TabControl Grid.Row="1" Grid.Column="1" x:Name="MainTabs" TabStripPlacement="Left">
      <!-- PREPARAR -->
      <TabItem x:Name="TabMaster1" Header="Preparar">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="10">
            <Button x:Name="BtnLoadLayout" Content="Load Layout" Margin="0,0,0,8" Click="BtnLoadLayout_Click"/>

            <GroupBox x:Name="Master1EditorGroup" Header="Master 1">
              <StackPanel Margin="0,8,0,0">
                <TextBlock Text="Tipo:"/>
                <ComboBox x:Name="ComboMasterRoiRole" Margin="0,4,0,8"/>
                <TextBlock Text="Forma:"/>
                <ComboBox x:Name="ComboMasterRoiShape" Margin="0,4,0,8">
                  <ComboBoxItem Content="Rectángulo"/>
                  <ComboBoxItem Content="Círculo"/>
                </ComboBox>
                <WrapPanel>
                  <Button x:Name="BtnSaveMaster" Content="Save Master 1" Click="BtnSaveMaster_Click" Margin="0,0,8,0"/>
                  <Button x:Name="BtnValidateM1" Content="Validar Master 1" Click="BtnValidateM1_Click"/>
                </WrapPanel>

                <Border Margin="0,12,0,0" Background="#11000000" Padding="8">
                  <TextBlock x:Name="TxtMasterHints" TextWrapping="Wrap"/>
                </Border>
              </StackPanel>
            </GroupBox>
          </StackPanel>
        </ScrollViewer>
      </TabItem>

      <!-- ALINEACIÓN -->
      <TabItem x:Name="TabMaster2" Header="Alineación">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="10">
            <GroupBox x:Name="Master2EditorGroup" Header="Master 2">
              <StackPanel Margin="0,8,0,0">
                <TextBlock Text="Tipo:"/>
                <ComboBox x:Name="ComboM2Role" Margin="0,4,0,8"/>
                <TextBlock Text="Forma:"/>
                <ComboBox x:Name="ComboM2Shape" Margin="0,4,0,8">
                  <ComboBoxItem Content="Rectángulo"/>
                  <ComboBoxItem Content="Círculo"/>
                </ComboBox>
                <WrapPanel>
                  <Button Content="Save Master 2" Click="BtnSaveMaster_Click" Margin="0,0,8,0"/>
                  <Button x:Name="BtnValidateM2" Content="Validar Master 2" Click="BtnValidateM2_Click"/>
                </WrapPanel>
              </StackPanel>
            </GroupBox>
          </StackPanel>
        </ScrollViewer>
      </TabItem>

      <TabItem x:Name="TabInspection" Header="Inspección">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="10">
            <TextBlock Text="Inspection ROIs" FontWeight="SemiBold" Margin="0,0,0,8"/>

            <StackPanel Orientation="Horizontal" Margin="8,4,8,0">
              <TextBlock Text="Inspection 1" Width="120" VerticalAlignment="Center"/>
              <ComboBox x:Name="CmbShapeInspection1"
                        Width="130"
                        Tag="1"
                        ItemsSource="{Binding AvailableShapes}"
                        SelectedItem="{Binding DataContext.InspectionRois[0].Shape, ElementName=WorkflowHost, Mode=TwoWay}"
                        SelectionChanged="InspectionShape_SelectionChanged"/>
              <Button x:Name="BtnToggleInspection1"
                      Margin="8,0,0,0"
                      Click="BtnToggleInspection1_Click">
                <Button.Content>
                  <TextBlock Text="{Binding Inspection1.IsFrozen, Converter={StaticResource BoolToEditSaveText}}"/>
                </Button.Content>
              </Button>
              <Button x:Name="BtnAddOkInspection1"
                      Margin="8,0,0,0"
                      Content="Add to OK"
                      Command="{Binding DataContext.AddRoiToOkCommand, ElementName=WorkflowHost}"
                      CommandParameter="{Binding Inspection1}"/>
              <Button x:Name="BtnAddNgInspection1"
                      Margin="8,0,0,0"
                      Content="Add to NG"
                      Command="{Binding DataContext.AddRoiToNgCommand, ElementName=WorkflowHost}"
                      CommandParameter="{Binding Inspection1}"/>
            </StackPanel>

            <StackPanel Orientation="Horizontal" Margin="8,4,8,0">
              <TextBlock Text="Inspection 2" Width="120" VerticalAlignment="Center"/>
              <ComboBox x:Name="CmbShapeInspection2"
                        Width="130"
                        Tag="2"
                        ItemsSource="{Binding AvailableShapes}"
                        SelectedItem="{Binding DataContext.InspectionRois[1].Shape, ElementName=WorkflowHost, Mode=TwoWay}"
                        SelectionChanged="InspectionShape_SelectionChanged"/>
              <Button x:Name="BtnToggleInspection2"
                      Margin="8,0,0,0"
                      Click="BtnToggleInspection2_Click">
                <Button.Content>
                  <TextBlock Text="{Binding Inspection2.IsFrozen, Converter={StaticResource BoolToEditSaveText}}"/>
                </Button.Content>
              </Button>
              <Button x:Name="BtnAddOkInspection2"
                      Margin="8,0,0,0"
                      Content="Add to OK"
                      Command="{Binding DataContext.AddRoiToOkCommand, ElementName=WorkflowHost}"
                      CommandParameter="{Binding Inspection2}"/>
              <Button x:Name="BtnAddNgInspection2"
                      Margin="8,0,0,0"
                      Content="Add to NG"
                      Command="{Binding DataContext.AddRoiToNgCommand, ElementName=WorkflowHost}"
                      CommandParameter="{Binding Inspection2}"/>
            </StackPanel>

            <StackPanel Orientation="Horizontal" Margin="8,4,8,0">
              <TextBlock Text="Inspection 3" Width="120" VerticalAlignment="Center"/>
              <ComboBox x:Name="CmbShapeInspection3"
                        Width="130"
                        Tag="3"
                        ItemsSource="{Binding AvailableShapes}"
                        SelectedItem="{Binding DataContext.InspectionRois[2].Shape, ElementName=WorkflowHost, Mode=TwoWay}"
                        SelectionChanged="InspectionShape_SelectionChanged"/>
              <Button x:Name="BtnToggleInspection3"
                      Margin="8,0,0,0"
                      Click="BtnToggleInspection3_Click">
                <Button.Content>
                  <TextBlock Text="{Binding Inspection3.IsFrozen, Converter={StaticResource BoolToEditSaveText}}"/>
                </Button.Content>
              </Button>
              <Button x:Name="BtnAddOkInspection3"
                      Margin="8,0,0,0"
                      Content="Add to OK"
                      Command="{Binding DataContext.AddRoiToOkCommand, ElementName=WorkflowHost}"
                      CommandParameter="{Binding Inspection3}"/>
              <Button x:Name="BtnAddNgInspection3"
                      Margin="8,0,0,0"
                      Content="Add to NG"
                      Command="{Binding DataContext.AddRoiToNgCommand, ElementName=WorkflowHost}"
                      CommandParameter="{Binding Inspection3}"/>
            </StackPanel>

            <StackPanel Orientation="Horizontal" Margin="8,4,8,0">
              <TextBlock Text="Inspection 4" Width="120" VerticalAlignment="Center"/>
              <ComboBox x:Name="CmbShapeInspection4"
                        Width="130"
                        Tag="4"
                        ItemsSource="{Binding AvailableShapes}"
                        SelectedItem="{Binding DataContext.InspectionRois[3].Shape, ElementName=WorkflowHost, Mode=TwoWay}"
                        SelectionChanged="InspectionShape_SelectionChanged"/>
              <Button x:Name="BtnToggleInspection4"
                      Margin="8,0,0,0"
                      Click="BtnToggleInspection4_Click">
                <Button.Content>
                  <TextBlock Text="{Binding Inspection4.IsFrozen, Converter={StaticResource BoolToEditSaveText}}"/>
                </Button.Content>
              </Button>
              <Button x:Name="BtnAddOkInspection4"
                      Margin="8,0,0,0"
                      Content="Add to OK"
                      Command="{Binding DataContext.AddRoiToOkCommand, ElementName=WorkflowHost}"
                      CommandParameter="{Binding Inspection4}"/>
              <Button x:Name="BtnAddNgInspection4"
                      Margin="8,0,0,0"
                      Content="Add to NG"
                      Command="{Binding DataContext.AddRoiToNgCommand, ElementName=WorkflowHost}"
                      CommandParameter="{Binding Inspection4}"/>
            </StackPanel>

            <Separator Margin="0,12,0,12"/>

            <GroupBox Header="Analyze options" Margin="0,0,0,12">
              <StackPanel Margin="8,4,0,0">
                <CheckBox Content="Lock scale"
                          IsChecked="{Binding ScaleLock, Mode=TwoWay}"/>
                <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                  <TextBlock Text="Position tolerance (px)"
                             Width="180"
                             VerticalAlignment="Center"/>
                  <TextBox Width="80"
                           Margin="0,0,8,0"
                           Text="{Binding AnalyzePosTolerancePx, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F2}}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                  <TextBlock Text="Angle tolerance (deg)"
                             Width="180"
                             VerticalAlignment="Center"/>
                  <TextBox Width="80"
                           Text="{Binding AnalyzeAngToleranceDeg, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F2}}"/>
                </StackPanel>
              </StackPanel>
            </GroupBox>

            <TextBlock Text="Feature (sin geom):"/>
            <ComboBox x:Name="ComboFeature" Margin="0,4,0,8">
              <ComboBoxItem Content="auto"/>
              <ComboBoxItem Content="sift"/>
              <ComboBoxItem Content="orb"/>
              <ComboBoxItem Content="tm_rot"/>
            </ComboBox>
            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
              <TextBlock Text="Thr:" VerticalAlignment="Center"/>
              <TextBox x:Name="TxtThr" Width="60" Margin="6,0,16,0" Text="85"/>
              <TextBlock Text="RotRange:" VerticalAlignment="Center"/>
              <TextBox x:Name="TxtRot" Width="60" Margin="6,0,16,0" Text="10"/>
              <TextBlock Text="ScaleMin:" VerticalAlignment="Center"/>
              <TextBox x:Name="TxtSMin" Width="60" Margin="6,0,16,0" Text="0.95"/>
              <TextBlock Text="ScaleMax:" VerticalAlignment="Center"/>
              <TextBox x:Name="TxtSMax" Width="60" Margin="6,0,0,0" Text="1.05"/>
            </StackPanel>
            <WrapPanel>
              <Button x:Name="BtnSavePreset" Content="Guardar Preset" Click="BtnSavePreset_Click" Margin="0,0,8,0"/>
              <Button x:Name="BtnSaveLayout" Content="Guardar Layout" Click="BtnSaveLayout_Click" Margin="0,0,8,0"/>
            </WrapPanel>

            <TextBlock x:Name="ResultLabel"
                       Text="Sin resultado"
                       FontSize="16"
                       FontWeight="Bold"
                       Foreground="#ddd"
                       Margin="0,12,0,0"/>

            <workflow:WorkflowControl x:Name="WorkflowHost" Margin="0,12,0,0"/>
          </StackPanel>
        </ScrollViewer>
      </TabItem>

    </TabControl>

      <!-- ===== Viewer/Canvas (right) ===== -->
      <Grid Grid.Column="0" Grid.RowSpan="2" x:Name="ViewerHost">
      <Grid Margin="10">
        <AdornerDecorator>
          <Grid Background="#111">
            <Grid>
              <Image x:Name="ImgMain" Stretch="Uniform" Panel.ZIndex="0" />
              <Image x:Name="HeatmapOverlay"
                     IsHitTestVisible="False"
                     Stretch="Fill"
                     HorizontalAlignment="Left"
                     VerticalAlignment="Top"
                     SnapsToDevicePixels="True"
                     Opacity="{Binding HeatmapOverlayOpacity, RelativeSource={RelativeSource AncestorType=Window}}"
                     Visibility="Collapsed"
                     Panel.ZIndex="1"/>
              <Canvas x:Name="CanvasROI"
                      Background="Transparent"
                      IsHitTestVisible="True"
                      Panel.ZIndex="2"/>
              <local:RoiOverlay x:Name="RoiOverlay"
                                Visibility="Collapsed"
                                IsHitTestVisible="False"
                                Panel.ZIndex="3"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"/>
            </Grid>
          </Grid>
        </AdornerDecorator>

        <!-- ROI Toolbar (overlay) -->
        <ToolBarTray x:Name="TopLeftTray"
                     Panel.ZIndex="1000"
                     HorizontalAlignment="Left"
                     VerticalAlignment="Top"
                     Margin="8"
                     IsLocked="True"
                     Background="#222"
                     Visibility="Visible">
          <ToolBar x:Name="TbPrimaryCommands" Band="0" BandIndex="0" Padding="2">
            <Button x:Name="BtnLoadImage"
                    Content="Cargar imagen"
                    MinWidth="120"
                    Margin="0,0,4,0"
                    ToolTip="Abrir una imagen"
                    Click="BtnLoadImage_Click"/>
            <Button x:Name="BtnAnalyzeMaster"
                    Content="Analyze Master"
                    MinWidth="120"
                    Margin="0,0,4,0"
                    ToolTip="Analizar masters actuales"
                    Click="BtnAnalyzeMaster_Click"/>
            <Button x:Name="BtnLoadPreset"
                    Content="Cargar preset"
                    MinWidth="130"
                    Margin="0,0,4,0"
                    ToolTip="Cargar configuración guardada"
                    Click="BtnLoadPreset_Click"
                    IsEnabled="{Binding IsImageLoaded}"/>
            <Separator/>
            <CheckBox x:Name="ChkScaleLock"
                      Content="Scale Lock"
                      Margin="4,0,4,0"
                      ToolTip="Bloquear escala durante análisis"
                      IsChecked="{Binding ScaleLock, Mode=TwoWay}"/>
            <CheckBox x:Name="ChkUseLocalMatcher"
                      Content="Usar matcher local"
                      Margin="4,0,0,0"
                      ToolTip="Forzar matcher local"/>
          </ToolBar>

          <ToolBar x:Name="TbDrawTools" Band="1" BandIndex="0" Padding="2">
            <ToggleButton x:Name="RectToolButton"
                          Content="Rect"
                          Margin="0,0,4,0"
                          Tag="Rectangle"
                          ToolTip="Dibujar rectángulos"
                          Checked="DrawToolToggle_Checked"
                          Unchecked="DrawToolToggle_Unchecked"/>
            <ToggleButton x:Name="CircleToolButton"
                          Content="Circ"
                          Margin="0,0,4,0"
                          Tag="Circle"
                          ToolTip="Dibujar círculos"
                          Checked="DrawToolToggle_Checked"
                          Unchecked="DrawToolToggle_Unchecked"/>
            <ToggleButton x:Name="AnnulusToolButton"
                          Content="Annulus"
                          Margin="0,0,4,0"
                          Tag="Annulus"
                          ToolTip="Dibujar anillos"
                          Checked="DrawToolToggle_Checked"
                          Unchecked="DrawToolToggle_Unchecked"/>
            <Separator/>
            <Button x:Name="BtnClearRoi"
                    Content="Borrar"
                    MinWidth="80"
                    ToolTip="Eliminar ROI actual"
                    Click="BtnClearRoi_Click"/>
          </ToolBar>
        </ToolBarTray>

        <Border x:Name="RoiVisibilityPanel"
                HorizontalAlignment="Left"
                VerticalAlignment="Bottom"
                Margin="8"
                Padding="6"
                Background="#CC1E1E1E"
                CornerRadius="6"
                Panel.ZIndex="900"
                DataContext="{Binding DataContext, ElementName=WorkflowHost}">
          <StackPanel Orientation="Horizontal">
            <StackPanel.Resources>
              <Style TargetType="Button">
                <Setter Property="Foreground" Value="White"/>
              </Style>
              <Style TargetType="ToggleButton">
                <Setter Property="Foreground" Value="White"/>
              </Style>
              <Style TargetType="CheckBox">
                <Setter Property="Foreground" Value="White"/>
              </Style>
              <Style TargetType="TextBlock">
                <Setter Property="Foreground" Value="White"/>
              </Style>
            </StackPanel.Resources>
            <CheckBox x:Name="ChkShowMaster1Pattern"
                      Content="Master 1"
                      IsChecked="{Binding ShowMaster1Pattern}"
                      Margin="0,0,6,0"
                      Checked="RoiVisibilityCheckChanged"
                      Unchecked="RoiVisibilityCheckChanged"/>
            <CheckBox x:Name="ChkShowMaster1Inspection"
                      Content="Search 1"
                      IsChecked="{Binding ShowMaster1Inspection}"
                      Margin="0,0,6,0"
                      Checked="RoiVisibilityCheckChanged"
                      Unchecked="RoiVisibilityCheckChanged"/>
            <CheckBox x:Name="ChkShowMaster2Pattern"
                      Content="Master 2"
                      IsChecked="{Binding ShowMaster2Pattern}"
                      Margin="0,0,6,0"
                      Checked="RoiVisibilityCheckChanged"
                      Unchecked="RoiVisibilityCheckChanged"/>
            <CheckBox x:Name="ChkShowMaster2Inspection"
                      Content="Search 2"
                      IsChecked="{Binding ShowMaster2Inspection}"
                      Margin="0,0,6,0"
                      Checked="RoiVisibilityCheckChanged"
                      Unchecked="RoiVisibilityCheckChanged"/>
            <CheckBox x:Name="ChkShowInspectionRoi"
                      Content="Inspection"
                      IsChecked="{Binding ShowInspectionRoi}"
                      Margin="0,0,6,0"
                      Checked="RoiVisibilityCheckChanged"
                      Unchecked="RoiVisibilityCheckChanged"/>
          </StackPanel>
        </Border>
      </Grid>
      <Grid x:Name="DiskStatusHUD"
            HorizontalAlignment="Right"
            VerticalAlignment="Top"
            Margin="12"
            Panel.ZIndex="950"
            Visibility="Collapsed"
            IsHitTestVisible="False">
        <Border x:Name="DiskStatusPanel"
                Background="#CC000000"
                BorderBrush="#39FF14"
                BorderThickness="1.5"
                CornerRadius="6"
                Padding="8">
          <TextBlock x:Name="DiskStatusText"
                     Text=""
                     FontFamily="Segoe UI"
                     FontWeight="Bold"
                     FontSize="22"
                     Foreground="White"/>
        </Border>
      </Grid>
      <!-- ===== HUD: ROI list (top-left) ===== -->
      <Grid x:Name="RoiHudOverlay"
            HorizontalAlignment="Left"
            VerticalAlignment="Top"
            Margin="12"
            Panel.ZIndex="900"
            IsHitTestVisible="True"
            Visibility="Collapsed">
        <Border x:Name="RoiHudPanel"
                Background="#CC000000"
                BorderBrush="#39FF14"
                BorderThickness="1.5"
                CornerRadius="6"
                Padding="8">
          <StackPanel x:Name="RoiHudStack" />
        </Border>
      </Grid>
      <!-- ===== HUD: bottom-right Heatmap controls ===== -->
      <Grid x:Name="HudOverlay" Panel.ZIndex="1000" IsHitTestVisible="True">
        <Border x:Name="HeatmapHUD"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Margin="16"
                Background="#CC000000"
                CornerRadius="6"
                Padding="8"
                IsHitTestVisible="True">
          <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
            <CheckBox x:Name="ChkHeatmap"
                      Content="Heatmap"
                      IsChecked="True"
                      Margin="0,0,8,0"/>
            <TextBlock x:Name="HeatmapScaleLabel"
                       Text="Heatmap Scale: 1.00"
                       Foreground="#39FF14"
                       FontFamily="Segoe UI"
                       FontWeight="SemiBold"
                       Margin="0,0,8,0"/>
            <Slider x:Name="HeatmapScaleSlider"
                    Width="160"
                    Minimum="0.10"
                    Maximum="2.00"
                    Value="1.00"
                    Margin="0,0,12,0"/>
            <TextBlock Text="Opacity"
                       Foreground="#39FF14"
                       FontFamily="Segoe UI"
                       FontWeight="SemiBold"
                       Margin="0,0,8,0"/>
            <Slider x:Name="HeatmapOpacitySlider"
                    Width="140"
                    Minimum="0"
                    Maximum="1"
                    TickFrequency="0.05"
                    IsSnapToTickEnabled="True"
                    Value="{Binding HeatmapOverlayOpacity, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
          </StackPanel>
        </Border>
      </Grid>
    </Grid>
  </Grid>
</Window>

<Window x:Class="BrakeDiscInspector_GUI_ROI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:BrakeDiscInspector_GUI_ROI"
        xmlns:workflow="clr-namespace:BrakeDiscInspector_GUI_ROI.Workflow"
        Title="BrakeDiscInspector"
        WindowState="Maximized"
        WindowStartupLocation="CenterScreen"
        Background="#0E0E10"
        UseLayoutRounding="True">

  <Grid x:Name="RootGrid">
    <Grid.ColumnDefinitions>
      <!-- Left: tabs -->
      <ColumnDefinition Width="320"/>
      <!-- Right: viewer/canvas -->
      <ColumnDefinition Width="*"/>
    </Grid.ColumnDefinitions>

    <!-- ===== Tabs (left) ===== -->
    <TabControl Grid.Column="0" x:Name="LeftTabs" TabStripPlacement="Left">
      <!-- PREPARAR -->
      <TabItem x:Name="TabMaster1" Header="Preparar">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="10">
            <Button x:Name="BtnLoadLayout" Content="Load Layout" Margin="0,0,0,8" Click="BtnLoadLayout_Click"/>
            <Button x:Name="BtnLoadModels" Content="Load Models" Margin="0,0,0,8"/>
            <Button x:Name="BtnLoadImage" Content="Cargar imagen" Click="BtnLoadImage_Click"/>

            <Separator Margin="0,12,0,12"/>

            <TextBlock Text="Master 1" FontWeight="SemiBold" Margin="0,0,0,8"/>
            <TextBlock Text="Tipo:"/>
            <ComboBox x:Name="ComboMasterRoiRole" Margin="0,4,0,8"/>
            <TextBlock Text="Forma:"/>
            <ComboBox x:Name="ComboMasterRoiShape" Margin="0,4,0,8">
              <ComboBoxItem Content="Rectángulo"/>
              <ComboBoxItem Content="Círculo"/>
            </ComboBox>
            <WrapPanel>
              <Button x:Name="BtnSaveMaster" Content="Save Master 1" Click="BtnSaveMaster_Click" Margin="0,0,8,0"/>
              <Button x:Name="BtnValidateM1" Content="Validar Master 1" Click="BtnValidateM1_Click"/>
            </WrapPanel>

            <Border Margin="0,12,0,0" Background="#11000000" Padding="8">
              <TextBlock x:Name="TxtMasterHints" TextWrapping="Wrap"/>
            </Border>
          </StackPanel>
        </ScrollViewer>
      </TabItem>

      <!-- ALINEACIÓN -->
      <TabItem x:Name="TabMaster2" Header="Alineación">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="10">
            <CheckBox x:Name="ChkScaleLock" Content="Scale-Lock (default)" IsChecked="True"/>
            <CheckBox x:Name="ChkUseLocalMatcher" Margin="0,8,0,0" Content="Usar matcher local" IsChecked="True"/>

            <Separator Margin="0,12,0,12"/>

            <Button x:Name="BtnAnalyzeMaster" Content="Analyze Master" Margin="0,0,0,8" Click="BtnAnalyzeMaster_Click"/>
            <Button x:Name="BtnAnalyzeROI" Content="Analyze ROI" Margin="0,0,0,8" Click="BtnAnalyzeROI_Click"/>
            <Button x:Name="BtnCenterPatterns" Content="Center Patterns on Crosses"/>

            <Separator Margin="0,12,0,12"/>

            <TextBlock Text="Master 2" FontWeight="SemiBold" Margin="0,0,0,8"/>
            <TextBlock Text="Tipo:"/>
            <ComboBox x:Name="ComboM2Role" Margin="0,4,0,8"/>
            <TextBlock Text="Forma:"/>
            <ComboBox x:Name="ComboM2Shape" Margin="0,4,0,8">
              <ComboBoxItem Content="Rectángulo"/>
              <ComboBoxItem Content="Círculo"/>
            </ComboBox>
            <WrapPanel>
              <Button Content="Save Master 2" Click="BtnSaveMaster_Click" Margin="0,0,8,0"/>
              <Button x:Name="BtnValidateM2" Content="Validar Master 2" Click="BtnValidateM2_Click"/>
            </WrapPanel>
          </StackPanel>
        </ScrollViewer>
      </TabItem>

      <!-- ROIs -->
      <TabItem x:Name="TabInspection" Header="ROIs">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="10">
            <TextBlock Text="Inspection ROIs (1–4)" FontWeight="SemiBold" Margin="0,0,0,8"/>
            <ItemsControl x:Name="RoiList" ItemsSource="{Binding Layout.InspectionRois}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <StackPanel Margin="0,0,0,12">
                    <CheckBox Content="{Binding DisplayName}" IsChecked="{Binding Enabled}"/>
                    <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                      <TextBlock Text="Model:" Width="70" VerticalAlignment="Center"/>
                      <ComboBox Width="200" SelectedItem="{Binding ModelKey}"
                                ItemsSource="{Binding DataContext.AvailableModels,
                                              RelativeSource={RelativeSource AncestorType=Window}}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                      <TextBlock Text="Threshold:" Width="70" VerticalAlignment="Center"/>
                      <TextBox Width="80" Text="{Binding Threshold}"/>
                      <!-- Optionally disable TextBox if a calibrated threshold exists for ModelKey -->
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                      <TextBlock Text="Shape:" Width="70" VerticalAlignment="Center"/>
                      <ComboBox Width="120" SelectedItem="{Binding Shape}"
                                ItemsSource="{Binding DataContext.AvailableShapes,
                                              RelativeSource={RelativeSource AncestorType=Window}}"/>
                    </StackPanel>
                  </StackPanel>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>

            <Separator Margin="0,12,0,12"/>

            <TextBlock Text="Forma:"/>
            <ComboBox x:Name="ComboInspShape" Margin="0,4,0,8">
              <ComboBoxItem Content="Rectángulo"/>
              <ComboBoxItem Content="Círculo"/>
              <ComboBoxItem Content="Annulus"/>
            </ComboBox>
            <WrapPanel>
              <Button Content="Save ROI Inspection" Click="BtnSaveMaster_Click" Margin="0,0,8,0"/>
              <Button x:Name="BtnValidateInsp" Content="Validar Inspección" Click="BtnValidateInsp_Click"/>
            </WrapPanel>
            <TextBlock Text="Tras 'Analizar Master', el ROI se recoloca al punto medio de M1 y M2." Margin="0,8,0,0"/>

            <GroupBox Header="Visibilidad ROI" Margin="0,12,0,0">
              <StackPanel>
                <CheckBox x:Name="ChkShowMaster1Pattern"
                          Content="Master 1"
                          IsEnabled="False"
                          IsChecked="False"
                          Checked="RoiVisibilityCheckChanged"
                          Unchecked="RoiVisibilityCheckChanged"/>
                <CheckBox x:Name="ChkShowMaster1Inspection"
                          Content="Inspection Master 1"
                          IsEnabled="False"
                          IsChecked="False"
                          Margin="0,4,0,0"
                          Checked="RoiVisibilityCheckChanged"
                          Unchecked="RoiVisibilityCheckChanged"/>
                <CheckBox x:Name="ChkShowMaster2Pattern"
                          Content="Master 2"
                          IsEnabled="False"
                          IsChecked="False"
                          Margin="0,4,0,0"
                          Checked="RoiVisibilityCheckChanged"
                          Unchecked="RoiVisibilityCheckChanged"/>
                <CheckBox x:Name="ChkShowMaster2Inspection"
                          Content="Inspection Master 2"
                          IsEnabled="False"
                          IsChecked="False"
                          Margin="0,4,0,0"
                          Checked="RoiVisibilityCheckChanged"
                          Unchecked="RoiVisibilityCheckChanged"/>
                <CheckBox x:Name="ChkShowInspectionRoi"
                          Content="Inspection ROI"
                          IsEnabled="False"
                          IsChecked="False"
                          Margin="0,4,0,0"
                          Checked="RoiVisibilityCheckChanged"
                          Unchecked="RoiVisibilityCheckChanged"/>
              </StackPanel>
            </GroupBox>
          </StackPanel>
        </ScrollViewer>
      </TabItem>

      <!-- INSPECCIÓN -->
      <TabItem x:Name="TabPresets" Header="Inspección">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="10">
            <Button x:Name="BtnRunSelected" Content="Run Selected" Margin="0,0,0,8"/>
            <Button x:Name="BtnRunAll" Content="Run All" Margin="0,0,0,8"/>
            <Button x:Name="BtnExport" Content="Export Results"/>

            <Separator Margin="0,12,0,12"/>

            <TextBlock Text="Feature (sin geom):"/>
            <ComboBox x:Name="ComboFeature" Margin="0,4,0,8">
              <ComboBoxItem Content="auto"/>
              <ComboBoxItem Content="sift"/>
              <ComboBoxItem Content="orb"/>
              <ComboBoxItem Content="tm_rot"/>
            </ComboBox>
            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
              <TextBlock Text="Thr:" VerticalAlignment="Center"/>
              <TextBox x:Name="TxtThr" Width="60" Margin="6,0,16,0" Text="85"/>
              <TextBlock Text="RotRange:" VerticalAlignment="Center"/>
              <TextBox x:Name="TxtRot" Width="60" Margin="6,0,16,0" Text="10"/>
              <TextBlock Text="ScaleMin:" VerticalAlignment="Center"/>
              <TextBox x:Name="TxtSMin" Width="60" Margin="6,0,16,0" Text="0.95"/>
              <TextBlock Text="ScaleMax:" VerticalAlignment="Center"/>
              <TextBox x:Name="TxtSMax" Width="60" Margin="6,0,0,0" Text="1.05"/>
            </StackPanel>
            <WrapPanel>
              <Button x:Name="BtnSavePreset" Content="Guardar Preset" Click="BtnSavePreset_Click" Margin="0,0,8,0"/>
              <Button x:Name="BtnLoadPreset" Content="Cargar Preset..." Click="BtnLoadPreset_Click" Margin="0,0,8,0"/>
              <Button x:Name="BtnSaveLayout" Content="Guardar Layout" Click="BtnSaveLayout_Click" Margin="0,0,8,0"/>
            </WrapPanel>

            <TextBlock x:Name="ResultLabel"
                       Text="Sin resultado"
                       FontSize="16"
                       FontWeight="Bold"
                       Foreground="#ddd"
                       Margin="0,12,0,0"/>

            <GroupBox Header="Log" Margin="0,12,0,0">
              <ScrollViewer VerticalScrollBarVisibility="Auto" Height="300">
                <TextBox x:Name="TrainLogText" TextWrapping="Wrap" IsReadOnly="True" AcceptsReturn="True" Background="#111" Foreground="#ddd"/>
              </ScrollViewer>
            </GroupBox>

            <workflow:WorkflowControl x:Name="WorkflowHost" Margin="0,12,0,0"/>
          </StackPanel>
        </ScrollViewer>
      </TabItem>
    </TabControl>

    <!-- ===== Viewer/Canvas (right) ===== -->
    <Grid Grid.Column="1" x:Name="ViewerHost">
      <Grid Margin="10">
        <AdornerDecorator>
          <Grid Background="#111">
            <Grid>
              <Image x:Name="ImgMain" Stretch="Uniform" Panel.ZIndex="0" />
              <Image x:Name="HeatmapOverlay"
                     IsHitTestVisible="False"
                     Stretch="Fill"
                     HorizontalAlignment="Left"
                     VerticalAlignment="Top"
                     SnapsToDevicePixels="True"
                     Opacity="0.75"
                     Visibility="Collapsed"
                     Panel.ZIndex="1"/>
              <Canvas x:Name="CanvasROI"
                      Background="Transparent"
                      IsHitTestVisible="True"
                      Panel.ZIndex="2"/>
              <local:RoiOverlay x:Name="RoiOverlay"
                                Visibility="Collapsed"
                                IsHitTestVisible="False"
                                Panel.ZIndex="3"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"/>
            </Grid>
          </Grid>
        </AdornerDecorator>
      </Grid>
      <!-- ===== HUD: bottom-right Heatmap controls ===== -->
      <Grid x:Name="HudOverlay" Panel.ZIndex="1000" IsHitTestVisible="False">
        <Border x:Name="HeatmapHUD"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Margin="16"
                Background="#CC000000"
                CornerRadius="6"
                Padding="8"
                IsHitTestVisible="True">
          <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
            <CheckBox x:Name="ChkHeatmap"
                      Content="Heatmap"
                      IsChecked="True"
                      Margin="0,0,8,0"/>
            <TextBlock x:Name="HeatmapScaleLabel"
                       Text="Heatmap Scale: 1.00"
                       Foreground="#39FF14"
                       FontFamily="Segoe UI"
                       FontWeight="SemiBold"
                       Margin="0,0,8,0"/>
            <Slider x:Name="HeatmapScaleSlider"
                    Width="160"
                    Minimum="0.10"
                    Maximum="2.00"
                    Value="1.00"/>
          </StackPanel>
        </Border>
      </Grid>
    </Grid>
  </Grid>
</Window>
